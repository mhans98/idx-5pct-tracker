<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDX 5% Shareholder Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07080f;
  --bg-card: rgba(255,255,255,0.025);
  --border: rgba(255,255,255,0.06);
  --text: #e2e8f0;
  --text-dim: #64748b;
  --text-muted: #334155;
  --accent: #00E5A0;
  --accent-dim: rgba(0,229,160,0.12);
  --neg: #FF4D6A;
  --neg-dim: rgba(255,77,106,0.1);
  --neutral: #475569;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Outfit', -apple-system, sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: linear-gradient(160deg, #07080f 0%, #0c1219 35%, #0a1428 70%, #06090f 100%);
  color: var(--text); font-family: var(--sans); min-height: 100vh;
}
::selection { background: rgba(0,229,160,0.2); }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
.container { max-width: 1480px; margin: 0 auto; padding: 20px 24px 48px; }
body::before {
  content: ''; position: fixed; top: -200px; right: -200px;
  width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(0,229,160,0.06) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
.header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
.header-left { display: flex; flex-direction: column; gap: 6px; }
.header-title { display: flex; align-items: center; gap: 10px; }
.logo {
  width: 36px; height: 36px; border-radius: 9px;
  background: linear-gradient(135deg, var(--accent), #0088ff);
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 20px rgba(0,229,160,0.25); font-size: 16px;
}
.header h1 {
  font-size: 26px; font-weight: 800;
  background: linear-gradient(135deg, #fff, var(--accent));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.header-sub { font-size: 13px; color: var(--text-dim); }
.header-sub a { color: var(--text-dim); text-decoration: none; border-bottom: 1px dotted var(--text-dim); }
.controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 16px; border-radius: 9px; border: none;
  font-family: var(--sans); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.btn-primary {
  background: var(--accent); color: #0a0e17;
  box-shadow: 0 2px 12px rgba(0,229,160,0.3);
}
.btn-primary:hover { background: #00ffb0; transform: translateY(-1px); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.btn-secondary { background: var(--bg-card); color: var(--text-dim); border: 1px solid var(--border); }
.btn-secondary:hover { background: rgba(255,255,255,0.05); color: var(--text); }
.btn-danger { background: rgba(255,77,106,0.1); color: var(--neg); border: 1px solid rgba(255,77,106,0.2); }
.btn-danger:hover { background: rgba(255,77,106,0.2); }
.scrape-info {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 14px; border-radius: 9px;
  background: var(--bg-card); border: 1px solid var(--border);
  font-size: 12px; color: var(--text-dim);
}
.scrape-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--neutral); }
.scrape-dot.live { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
input[type="file"] { display: none; }

/* Progress bar */
.progress-wrap {
  display: none; margin-bottom: 16px; padding: 14px 18px;
  border-radius: 12px; background: var(--bg-card); border: 1px solid var(--border);
}
.progress-wrap.show { display: block; }
.progress-text { font-size: 13px; color: var(--text-dim); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.progress-bar { height: 4px; border-radius: 2px; background: rgba(255,255,255,0.06); overflow: hidden; }
.progress-fill {
  height: 100%; border-radius: 2px; background: var(--accent);
  animation: pulse 1.5s ease-in-out infinite;
  width: 40%;
}
@keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

/* Stats */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(175px, 1fr)); gap: 10px; margin: 20px 0; }
.stat-card {
  padding: 15px 17px; border-radius: 12px;
  background: var(--bg-card); border: 1px solid var(--border); transition: all 0.2s;
}
.stat-card:hover { border-color: rgba(255,255,255,0.12); }
.stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-dim); margin-bottom: 8px; }
.stat-value { font-size: 24px; font-weight: 700; font-family: var(--mono); color: #f1f5f9; }
.stat-sub { font-size: 11px; margin-top: 3px; font-weight: 500; }

/* Filters */
.filters { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.search-box {
  display: flex; align-items: center; gap: 8px;
  padding: 0 12px; border-radius: 10px; flex: 1 1 250px; max-width: 380px;
  background: var(--bg-card); border: 1px solid var(--border);
}
.search-box input {
  border: none; background: none; color: var(--text); outline: none;
  padding: 9px 0; font-size: 13px; width: 100%; font-family: var(--sans);
}
.search-box input::placeholder { color: var(--neutral); }
select {
  padding: 9px 12px; border-radius: 10px; border: 1px solid var(--border);
  background: rgba(255,255,255,0.03); color: var(--text); font-size: 12px;
  font-family: var(--sans); cursor: pointer; outline: none;
}
select option { background: #141820; }
.filter-group {
  display: flex; gap: 3px; border-radius: 10px; padding: 3px;
  background: var(--bg-card); border: 1px solid var(--border);
}
.filter-btn {
  padding: 5px 11px; border-radius: 7px; border: none;
  background: transparent; color: var(--text-dim);
  font-size: 11px; font-weight: 500; cursor: pointer; font-family: var(--sans); transition: all 0.15s;
}
.filter-btn.active { background: rgba(255,255,255,0.1); color: #fff; }

/* Table */
.table-wrap { border-radius: 14px; overflow: hidden; background: var(--bg-card); border: 1px solid var(--border); }
.table-inner { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
thead tr { border-bottom: 1px solid rgba(255,255,255,0.08); }
th {
  padding: 11px 12px; text-align: left; font-size: 10px; font-weight: 600;
  color: var(--neutral); text-transform: uppercase; letter-spacing: 0.5px;
  cursor: pointer; user-select: none; white-space: nowrap; transition: background 0.15s;
}
th:hover { background: rgba(255,255,255,0.02); }
th.active { color: var(--text-dim); }
th .sort-icon { font-size: 9px; margin-left: 3px; opacity: 0.4; }
th.active .sort-icon { opacity: 1; }
td { padding: 9px 12px; border-bottom: 1px solid rgba(255,255,255,0.025); }
tr { transition: background 0.1s; }
tr:hover { background: rgba(255,255,255,0.025); }
.ticker-badge {
  font-weight: 700; color: #f1f5f9; font-size: 12px; font-family: var(--mono);
  background: rgba(255,255,255,0.06); padding: 2px 7px; border-radius: 4px; display: inline-block;
}
.cell-date { color: var(--neutral); font-size: 11px; font-family: var(--mono); }
.cell-name { color: #94a3b8; font-size: 11.5px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cell-holder { color: #cbd5e1; font-size: 11.5px; max-width: 190px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cell-num { text-align: right; font-family: var(--mono); font-size: 11.5px; color: var(--text-dim); }
.own-bar { display: flex; align-items: center; gap: 6px; }
.own-track { width: 48px; height: 5px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden; }
.own-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
.own-pct { font-size: 11px; color: #94a3b8; font-family: var(--mono); min-width: 40px; text-align: right; }
.net-cell { display: flex; align-items: center; gap: 6px; justify-content: flex-end; }
.net-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; font-family: var(--mono); }
.net-badge.pos { background: var(--accent-dim); color: var(--accent); }
.net-badge.neg { background: var(--neg-dim); color: var(--neg); }
.net-badge.zero { color: var(--neutral); }
.net-pct { font-size: 10px; font-family: var(--mono); min-width: 48px; text-align: right; opacity: 0.6; }
.table-footer {
  padding: 9px 14px; border-top: 1px solid var(--border);
  display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);
}
.empty { text-align: center; padding: 80px 20px; color: var(--neutral); }
.empty-icon { font-size: 40px; margin-bottom: 16px; opacity: 0.4; }
.empty h3 { font-size: 16px; color: var(--text-dim); margin-bottom: 8px; }
.empty p { font-size: 13px; max-width: 480px; margin: 0 auto 20px; line-height: 1.6; }
.toast {
  position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px;
  font-size: 13px; font-weight: 500; z-index: 100;
  transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: #065f46; color: #a7f3d0; border: 1px solid #059669; }
.toast.error { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
.toast.info { background: #1e3a5f; color: #93c5fd; border: 1px solid #3b82f6; }
.attr { text-align: center; margin-top: 28px; font-size: 11px; color: var(--text-muted); }
.attr a { color: var(--neutral); text-decoration: none; }
/* Drop overlay */
.drop-overlay {
  display: none; position: fixed; inset: 0; z-index: 50;
  background: rgba(0,229,160,0.06); backdrop-filter: blur(4px);
  border: 3px dashed var(--accent);
  align-items: center; justify-content: center;
}
.drop-overlay.show { display: flex; }
.drop-overlay-inner { text-align: center; }
.drop-overlay-inner .icon { font-size: 48px; margin-bottom: 12px; }
.drop-overlay-inner p { font-size: 18px; font-weight: 600; color: var(--accent); }
@media (max-width: 768px) {
  .container { padding: 12px 12px 32px; }
  .header h1 { font-size: 20px; }
  .stats { grid-template-columns: repeat(2, 1fr); }
  .stat-value { font-size: 18px; }
}
</style>
</head>
<body>
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-overlay-inner">
    <div class="icon">ðŸ“¥</div>
    <p>Drop PDF files to upload</p>
  </div>
</div>
<div class="container">
  <div class="header">
    <div class="header-left">
      <div class="header-title">
        <div class="logo">ðŸ“Š</div>
        <h1>IDX 5% Shareholder Tracker</h1>
      </div>
      <div class="header-sub">
        Upload KSEI PDFs from
        <a href="https://www.idx.co.id/id/perusahaan-tercatat/keterbukaan-informasi" target="_blank">IDX Keterbukaan Informasi</a>
        â€” search "5%", download the lamp1 PDF attachments
      </div>
    </div>
    <div class="controls">
      <div class="scrape-info">
        <div class="scrape-dot" id="statusDot"></div>
        <span id="scrapeTime">No data yet</span>
      </div>
      <button class="btn btn-primary" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload PDFs
      </button>
      <button class="btn btn-secondary" onclick="exportCSV()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        CSV
      </button>
      <button class="btn btn-danger" onclick="clearData()" title="Clear all data">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      </button>
      <input type="file" id="fileInput" accept=".pdf" multiple onchange="handleFiles(this.files)">
    </div>
  </div>

  <!-- Progress -->
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-text">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round"><path d="M12 2v4m0 12v4m-7.07-3.93l2.83-2.83m8.48-8.48l2.83-2.83M2 12h4m12 0h4m-3.93 7.07l-2.83-2.83M7.76 7.76L4.93 4.93"/></svg>
      <span id="progressText">Processing...</span>
    </div>
    <div class="progress-bar"><div class="progress-fill"></div></div>
  </div>

  <!-- Stats -->
  <div class="stats" id="statsGrid">
    <div class="stat-card"><div class="stat-label">Total Filings</div><div class="stat-value" id="statTotal">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Tickers</div><div class="stat-value" id="statTickers">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Accumulation</div><div class="stat-value" id="statPos" style="color:var(--accent)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Distribution</div><div class="stat-value" id="statNeg" style="color:var(--neg)">â€”</div></div>
    <div class="stat-card">
      <div class="stat-label">Top Mover</div>
      <div class="stat-value" id="statTopTicker" style="font-size:18px">â€”</div>
      <div class="stat-sub" id="statTopChange" style="color:var(--accent)"></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="search-box">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="Search ticker, company, shareholder..." oninput="applyFilters()">
    </div>
    <select id="dateFilter" onchange="applyFilters()"><option value="all">All Dates</option></select>
    <div class="filter-group">
      <button class="filter-btn active" data-filter="all" onclick="setChangeFilter(this)">All</button>
      <button class="filter-btn" data-filter="positive" onclick="setChangeFilter(this)">â–² Buy</button>
      <button class="filter-btn" data-filter="negative" onclick="setChangeFilter(this)">â–¼ Sell</button>
      <button class="filter-btn" data-filter="zero" onclick="setChangeFilter(this)">â€” Hold</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <div id="tableContent">
      <div class="empty">
        <div class="empty-icon">ðŸ“¡</div>
        <h3>No Data Yet</h3>
        <p>
          <strong>Step 1:</strong> Go to <a href="https://www.idx.co.id/id/perusahaan-tercatat/keterbukaan-informasi" target="_blank" style="color:var(--accent)">IDX Keterbukaan Informasi</a> and search <strong>"5%"</strong><br>
          <strong>Step 2:</strong> Download the PDF attachments (lamp1.pdf files)<br>
          <strong>Step 3:</strong> Click <strong>"Upload PDFs"</strong> above or drag files onto this page
        </p>
      </div>
    </div>
    <div class="table-footer">
      <span id="footerCount">0 records</span>
      <span>IDX Keterbukaan Informasi â€¢ KSEI 5% Shareholder</span>
    </div>
  </div>
  <div class="attr">Data from <a href="https://www.idx.co.id" target="_blank">idx.co.id</a></div>
</div>
<div class="toast" id="toast"></div>

<script>
let allRecords = [];
let filteredRecords = [];
let sortKey = 'net_change';
let sortDir = 'desc';
let changeFilter = 'all';

function fmt(n) {
  if (n === 0) return '0';
  const a = Math.abs(n);
  if (a >= 1e9) return (n/1e9).toFixed(2) + 'B';
  if (a >= 1e6) return (n/1e6).toFixed(2) + 'M';
  if (a >= 1e3) return (n/1e3).toFixed(1) + 'K';
  return n.toLocaleString();
}
function fmtFull(n) { return (n || 0).toLocaleString(); }
function fmtDate(d) {
  if (!d) return 'â€”';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function fmtTimestamp(iso) {
  if (!iso) return 'No data yet';
  const dt = new Date(iso);
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
    ', ' + dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(() => t.classList.remove('show'), 4000);
}

// === DRAG & DROP (whole page) ===
let dragCounter = 0;
document.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; document.getElementById('dropOverlay').classList.add('show'); });
document.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if (dragCounter <= 0) { dragCounter = 0; document.getElementById('dropOverlay').classList.remove('show'); } });
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault(); dragCounter = 0;
  document.getElementById('dropOverlay').classList.remove('show');
  if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});

// === UPLOAD ===
function handleFiles(files) {
  const pdfs = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
  if (!pdfs.length) { showToast('Please select PDF files', 'error'); return; }

  const formData = new FormData();
  pdfs.forEach(f => formData.append('pdfs', f));

  // Show progress
  const pw = document.getElementById('progressWrap');
  const pt = document.getElementById('progressText');
  pw.classList.add('show');
  pt.textContent = 'Uploading ' + pdfs.length + ' PDF(s)...';
  document.getElementById('uploadBtn').disabled = true;

  showToast('Uploading ' + pdfs.length + ' PDF(s)...', 'info');

  fetch('/api/upload', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
      if (data.started) {
        pt.textContent = 'Processing ' + data.files + ' PDF(s)...';
        pollForCompletion();
      } else {
        pw.classList.remove('show');
        document.getElementById('uploadBtn').disabled = false;
        showToast(data.error || 'Upload failed', 'error');
      }
    })
    .catch(e => {
      pw.classList.remove('show');
      document.getElementById('uploadBtn').disabled = false;
      showToast('Upload error: ' + e.message, 'error');
    });

  // Reset file input so same file can be re-selected
  document.getElementById('fileInput').value = '';
}

let pollTimer = null;
function pollForCompletion() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const resp = await fetch('/api/status');
      const status = await resp.json();
      const pt = document.getElementById('progressText');

      if (status.processing) {
        pt.textContent = status.progress || 'Processing...';
        return;
      }

      clearInterval(pollTimer); pollTimer = null;
      document.getElementById('progressWrap').classList.remove('show');
      document.getElementById('uploadBtn').disabled = false;

      // Reload data
      const dataResp = await fetch('/api/data');
      const data = await dataResp.json();
      if (data.records && data.records.length > 0) {
        allRecords = data.records;
        updateScrapeTime(data.scraped_at);
        populateDateFilter();
        applyFilters();
        updateStats();
        showToast(status.progress || (data.total_records + ' records loaded'), 'success');
      } else {
        showToast(status.progress || 'No records found in PDFs', 'error');
      }
    } catch (e) { console.warn('Poll error:', e); }
  }, 2000);
}

// === CLEAR DATA ===
async function clearData() {
  if (!confirm('Clear all data? You can re-upload PDFs anytime.')) return;
  try {
    await fetch('/api/clear', { method: 'POST' });
    allRecords = [];
    filteredRecords = [];
    document.getElementById('statusDot').classList.remove('live');
    document.getElementById('scrapeTime').textContent = 'No data yet';
    applyFilters();
    updateStats();
    showToast('Data cleared', 'success');
  } catch (e) { showToast('Error: ' + e.message, 'error'); }
}

// === DATA DISPLAY ===
function updateScrapeTime(iso) {
  document.getElementById('statusDot').classList.add('live');
  document.getElementById('scrapeTime').innerHTML = 'Updated: <strong style="color:#e2e8f0">' + fmtTimestamp(iso) + '</strong>';
}
function updateStats() {
  const pos = filteredRecords.filter(r => r.net_change > 0);
  const neg = filteredRecords.filter(r => r.net_change < 0);
  document.getElementById('statTotal').textContent = filteredRecords.length;
  document.getElementById('statTickers').textContent = new Set(filteredRecords.map(r => r.ticker)).size;
  document.getElementById('statPos').textContent = pos.length;
  document.getElementById('statNeg').textContent = neg.length;
  if (pos.length) {
    const top = pos.reduce((a, b) => a.net_change > b.net_change ? a : b);
    document.getElementById('statTopTicker').textContent = top.ticker;
    document.getElementById('statTopChange').textContent = '+' + fmt(top.net_change);
    document.getElementById('statTopChange').style.color = 'var(--accent)';
  } else if (neg.length) {
    const top = neg.reduce((a, b) => a.net_change < b.net_change ? a : b);
    document.getElementById('statTopTicker').textContent = top.ticker;
    document.getElementById('statTopChange').textContent = fmt(top.net_change);
    document.getElementById('statTopChange').style.color = 'var(--neg)';
  } else {
    document.getElementById('statTopTicker').textContent = 'â€”';
    document.getElementById('statTopChange').textContent = '';
  }
}
function populateDateFilter() {
  const dates = [...new Set(allRecords.map(r => r.run_date))].sort().reverse();
  const sel = document.getElementById('dateFilter');
  sel.innerHTML = '<option value="all">All Dates (' + dates.length + ')</option>';
  dates.forEach(d => { sel.innerHTML += '<option value="' + d + '">' + fmtDate(d) + '</option>'; });
}
function setChangeFilter(btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  changeFilter = btn.dataset.filter;
  applyFilters();
}
function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const dateVal = document.getElementById('dateFilter').value;
  filteredRecords = allRecords.filter(r => {
    if (search && !r.ticker.toLowerCase().includes(search) && !(r.nama_emiten||'').toLowerCase().includes(search) && !(r.shareholder||'').toLowerCase().includes(search)) return false;
    if (dateVal !== 'all' && r.run_date !== dateVal) return false;
    if (changeFilter === 'positive' && r.net_change <= 0) return false;
    if (changeFilter === 'negative' && r.net_change >= 0) return false;
    if (changeFilter === 'zero' && r.net_change !== 0) return false;
    return true;
  });
  filteredRecords.sort((a, b) => {
    let av = a[sortKey], bv = b[sortKey];
    if (typeof av === 'string') { av = (av||'').toLowerCase(); bv = (bv||'').toLowerCase(); }
    if (sortDir === 'asc') return av < bv ? -1 : av > bv ? 1 : 0;
    return av > bv ? -1 : av < bv ? 1 : 0;
  });
  renderTable(); updateStats();
}
function handleSort(key) {
  if (sortKey === key) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  else { sortKey = key; sortDir = 'desc'; }
  applyFilters();
}
function renderTable() {
  const c = document.getElementById('tableContent');
  if (!allRecords.length) {
    c.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ“¡</div><h3>No Data Yet</h3><p><strong>Step 1:</strong> Go to <a href="https://www.idx.co.id/id/perusahaan-tercatat/keterbukaan-informasi" target="_blank" style="color:var(--accent)">IDX Keterbukaan Informasi</a> and search <strong>"5%"</strong><br><strong>Step 2:</strong> Download the PDF attachments (lamp1.pdf files)<br><strong>Step 3:</strong> Click <strong>"Upload PDFs"</strong> above or drag files onto this page</p></div>';
    document.getElementById('footerCount').textContent = '0 records'; return;
  }
  if (!filteredRecords.length) {
    c.innerHTML = '<div style="text-align:center;padding:48px;color:var(--neutral)">No matching records</div>';
    document.getElementById('footerCount').textContent = '0 of ' + allRecords.length; return;
  }
  const cols = [
    {key:'run_date',label:'Date'},{key:'ticker',label:'Ticker'},{key:'nama_emiten',label:'Emiten'},
    {key:'shareholder',label:'Shareholder'},{key:'pct_d1',label:'Ownership',align:'right'},
    {key:'shares_d2',label:'Shares D-2',align:'right'},{key:'shares_d1',label:'Shares D-1',align:'right'},
    {key:'net_change',label:'Net Change',align:'right'}
  ];
  let h = '<div class="table-inner"><table><thead><tr>';
  cols.forEach(col => {
    const act = sortKey === col.key;
    const arrow = act ? (sortDir === 'asc' ? 'â–²' : 'â–¼') : 'â‡…';
    h += '<th class="' + (act?'active':'') + '" style="text-align:' + (col.align||'left') + '" onclick="handleSort(\'' + col.key + '\')">' + col.label + ' <span class="sort-icon">' + arrow + '</span></th>';
  });
  h += '</tr></thead><tbody>';
  filteredRecords.forEach(r => {
    const pctColor = (r.pct_d1||0)>50?'#f59e0b':(r.pct_d1||0)>20?'var(--accent)':'#818cf8';
    const pctW = Math.min(r.pct_d1||0,100);
    let nc='zero',np=''; if(r.net_change>0){nc='pos';np='+';}else if(r.net_change<0){nc='neg';}
    const cp = r.shares_d2?((r.net_change/r.shares_d2)*100).toFixed(2):'0.00';
    h += '<tr>' +
      '<td class="cell-date">' + fmtDate(r.run_date) + '</td>' +
      '<td><span class="ticker-badge">' + r.ticker + '</span></td>' +
      '<td class="cell-name" title="' + (r.nama_emiten||'') + '">' + (r.nama_emiten||'') + '</td>' +
      '<td class="cell-holder" title="' + (r.shareholder||'') + '">' + (r.shareholder||'') + '</td>' +
      '<td style="text-align:right">' + (r.pct_d1 ? '<div class="own-bar"><div class="own-track"><div class="own-fill" style="width:'+pctW+'%;background:'+pctColor+'"></div></div><span class="own-pct">'+r.pct_d1.toFixed(1)+'%</span></div>' : '<span style="color:var(--text-muted)">â€”</span>') + '</td>' +
      '<td class="cell-num">' + fmtFull(r.shares_d2) + '</td>' +
      '<td class="cell-num" style="color:#94a3b8">' + fmtFull(r.shares_d1) + '</td>' +
      '<td><div class="net-cell"><span class="net-badge '+nc+'">' + np + fmt(r.net_change) + '</span><span class="net-pct" style="color:'+(r.net_change>0?'var(--accent)':r.net_change<0?'var(--neg)':'var(--neutral)')+'">' + (r.net_change!==0?np+cp+'%':'â€”') + '</span></div></td>' +
    '</tr>';
  });
  h += '</tbody></table></div>';
  c.innerHTML = h;
  document.getElementById('footerCount').textContent = filteredRecords.length + ' of ' + allRecords.length + ' records';
}
function exportCSV() {
  if (!filteredRecords.length) { showToast('No data to export', 'error'); return; }
  const hdr = ['Run Date','Ticker','Nama Emiten','Shareholder','% D-2','Shares D-2','% D-1','Shares D-1','Net Change','% Change'];
  const rows = filteredRecords.map(r => [r.run_date,r.ticker,r.nama_emiten||'',r.shareholder||'',r.pct_d2||'',r.shares_d2,r.pct_d1||'',r.shares_d1,r.net_change,r.shares_d2?((r.net_change/r.shares_d2)*100).toFixed(4)+'%':'0%']);
  const csv = [hdr,...rows].map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = 'idx_5pct_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
  showToast('CSV exported', 'success');
}

// Load existing data on page load
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const resp = await fetch('/api/data');
    const data = await resp.json();
    if (data.records && data.records.length > 0) {
      allRecords = data.records;
      updateScrapeTime(data.scraped_at);
      populateDateFilter();
      applyFilters();
      updateStats();
    }
  } catch (e) { console.log('No existing data'); }
});
</script>
</body>
</html>
